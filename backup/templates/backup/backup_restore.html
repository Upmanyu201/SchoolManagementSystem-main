{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<!-- Load enhanced backup JavaScript -->
<script src="{% static 'js/enhanced_backup.js' %}" defer></script>
<!-- Load Lucide icons for export system -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8 pt-24">
    <div class="container mx-auto px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header Card -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-blue-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-shield-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-800 bg-clip-text text-transparent">
                                Data Backup & Recovery Center
                            </h1>
                            <p class="text-gray-600 mt-1">Protect your school's valuable data with secure backup solutions</p>
                        </div>
                    </div>
                    <a href="{% url 'dashboard' %}" 
                       class="btn btn-secondary px-4 py-2 rounded-xl transition-all duration-300 hover:scale-105">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
            <!-- Data Export Section -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-8" x-data="exportSystem()">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i data-lucide="download" class="w-6 h-6 inline mr-2 text-green-500"></i>
                    Data Export System
                </h2>
                <p class="text-gray-600 mb-6">Export module data in CSV format</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" x-show="modules.length > 0">
                    <template x-for="module in modules" :key="module.key">
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center mb-3">
                                <i :data-lucide="module.icon" class="w-5 h-5 text-blue-500 mr-2"></i>
                                <h3 class="font-semibold text-gray-800" x-text="module.name"></h3>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="exportData(module.key, 'csv')" 
                                        class="bg-green-500 text-white px-2 py-2 rounded text-xs hover:bg-green-600 transition-colors"
                                        :disabled="exporting">
                                    <i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>
                                    CSV
                                </button>
                                <button @click="exportData(module.key, 'excel')" 
                                        class="bg-blue-500 text-white px-2 py-2 rounded text-xs hover:bg-blue-600 transition-colors"
                                        :disabled="exporting">
                                    <i data-lucide="file-spreadsheet" class="w-3 h-3 inline mr-1"></i>
                                    Excel
                                </button>
                                <button @click="exportData(module.key, 'pdf')" 
                                        class="bg-red-500 text-white px-2 py-2 rounded text-xs hover:bg-red-600 transition-colors"
                                        :disabled="exporting">
                                    <i data-lucide="file-type" class="w-3 h-3 inline mr-1"></i>
                                    PDF
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div x-show="modules.length === 0" class="text-center py-8">
                    <div class="text-gray-500">Loading export modules...</div>
                </div>
                
                <div x-show="exporting" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p class="text-gray-600">Exporting data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Backup Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transition-all duration-300 shadow-xl" onclick="createQuickBackup('full')">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-database text-3xl"></i>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">Complete</span>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Full System Backup</h3>
                    <p class="text-sm opacity-90">Complete backup of all school data</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transition-all duration-300 shadow-xl" onclick="createQuickBackup('students')">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-user-graduate text-3xl"></i>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">Academic</span>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Student Records</h3>
                    <p class="text-sm opacity-90">Student profiles, enrollment & academic data</p>
                </div>
                
                <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transition-all duration-300 shadow-xl" onclick="createQuickBackup('financial')">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-coins text-3xl"></i>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">Finance</span>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Financial Records</h3>
                    <p class="text-sm opacity-90">Fee payments, transactions & reports</p>
                </div>
                
                <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 text-white cursor-pointer hover:scale-105 transition-all duration-300 shadow-xl" onclick="createQuickBackup('teachers')">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-chalkboard-teacher text-3xl"></i>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">Staff</span>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Staff Records</h3>
                    <p class="text-sm opacity-90">Teacher profiles, subjects & attendance</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Backup Section -->
                <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6">
                        <h2 class="text-white text-xl font-bold flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-3"></i>Create Custom Backup
                        </h2>
                    </div>
                    <form method="POST" class="p-8">
                        {% csrf_token %}
                        <div class="space-y-6">
                            <div class="form-group">
                                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                                    <i class="fas fa-tag mr-2 text-blue-500"></i>Backup Name*
                                </label>
                                <div class="relative">
                                    <input type="text" id="backupName" 
                                           placeholder="e.g., monthly-backup-march-2024"
                                           class="form-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:ring-0 transition-all duration-300"
                                           maxlength="50" pattern="[a-zA-Z0-9_\\-]+"
                                           title="Only letters, numbers, hyphens and underscores allowed">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <i class="fas fa-edit text-gray-400"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Give your backup a meaningful name (letters, numbers, hyphens only)</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                                    <i class="fas fa-layer-group mr-2 text-indigo-500"></i>Backup Type
                                </label>
                                <select id="backupType" class="form-select w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:ring-0">
                                    <option value="full">Complete System Backup</option>
                                    <option value="students">Student Records Only</option>
                                    <option value="financial">Financial Data Only</option>
                                    <option value="teachers">Staff Records Only</option>
                                </select>
                            </div>
                            
                            <button type="button" id="backupBtn"
                                class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                                <i class="fas fa-save mr-3"></i>Create Backup Now
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Smart Restore Section -->
                <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6">
                        <h2 class="text-white text-xl font-bold flex items-center">
                            <i class="fas fa-magic mr-3"></i>Smart Restore System
                        </h2>
                        <p class="text-white/80 mt-1">Intelligent data restoration with category selection</p>
                    </div>
                    <div class="p-8">
                        <div class="space-y-6">
                            <!-- File Upload -->
                            <div class="form-group">
                                <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                                    <i class="fas fa-file-upload mr-2 text-green-500"></i>Select Backup File*
                                </label>
                                <div class="relative">
                                    <input type="file" id="smartRestoreFile" accept=".json"
                                        class="form-input block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer border-2 border-dashed border-gray-300 rounded-xl p-4 hover:border-green-400 transition-colors">
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Upload your backup file (.json format only, max 50MB)</p>
                            </div>

                            <!-- Restore Options -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                                        <i class="fas fa-layer-group mr-2 text-blue-500"></i>Restore Category
                                    </label>
                                    <select id="restoreCategory" class="form-select w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:ring-0">
                                        <option value="full">Complete System Restore</option>
                                        <option value="students">Student Records Only</option>
                                        <option value="staff">Staff Records Only</option>
                                        <option value="financial">Financial Data Only</option>
                                        <option value="transport">Transport Data Only</option>
                                        <option value="core">Core Settings Only</option>
                                        <option value="system">System Data (Users, Messages, Reports)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-gray-700 font-semibold mb-3 flex items-center">
                                        <i class="fas fa-cogs mr-2 text-purple-500"></i>Restore Mode
                                    </label>
                                    <select id="restoreMode" class="form-select w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:ring-0">
                                        <option value="merge">Merge (Safe - Keep existing data)</option>
                                        <option value="replace">Replace (Warning - Clear existing data)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Analysis Results -->
                            <div id="analysisResults" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                                <h4 class="text-lg font-bold text-blue-800 mb-4 flex items-center">
                                    <i class="fas fa-chart-pie mr-2"></i>Backup Analysis
                                </h4>
                                <div id="analysisContent" class="space-y-3">
                                    <!-- Analysis content will be populated here -->
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-4">
                                <button type="button" id="analyzeBtn"
                                    class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                                    <i class="fas fa-search mr-3"></i>Analyze Backup
                                </button>
                                
                                <button type="button" id="smartRestoreBtn" disabled
                                    class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-magic mr-3"></i>Start Smart Restore
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup History Table -->
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-white text-xl font-bold flex items-center">
                                <i class="fas fa-archive mr-3"></i>Backup Archive
                            </h2>
                            <p id="historyStatusText" class="text-white/80 mt-1">Manage your backup files and restore points</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="showAllBtn"
                                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                                <i class="fas fa-list mr-2"></i>Show All
                            </button>
                            <button id="refreshBtn"
                                class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                                    <i class="fas fa-file-archive mr-2 text-blue-500"></i>Backup File
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                                    <i class="fas fa-calendar-alt mr-2 text-green-500"></i>Created On
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                                    <i class="fas fa-tags mr-2 text-purple-500"></i>Operation
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-900 uppercase tracking-wider">
                                    <i class="fas fa-tools mr-2 text-orange-500"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="backupHistoryTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                                        <p class="text-gray-500">Loading your backup archive...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Export System Alpine.js Component
function exportSystem() {
    return {
        modules: [],
        exporting: false,
        
        async init() {
            await this.loadModules();
            // Initialize Lucide icons after modules load
            this.$nextTick(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        },
        
        async loadModules() {
            try {
                console.log('Loading export modules from /backup/api/export/modules/');
                const response = await fetch('/backup/api/export/modules/');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Modules data received:', data);
                
                if (data.status === 'success' && data.modules) {
                    this.modules = data.modules.map(module => ({
                        key: module.key,
                        name: module.name,
                        icon: this.getModuleIcon(module.key)
                    }));
                    console.log('Modules loaded successfully:', this.modules.length);
                } else if (data.modules) {
                    // Fallback for direct modules array
                    this.modules = data.modules.map(module => ({
                        key: module.key,
                        name: module.name,
                        icon: this.getModuleIcon(module.key)
                    }));
                    console.log('Modules loaded (fallback):', this.modules.length);
                } else {
                    throw new Error('No modules data in response');
                }
            } catch (error) {
                console.error('Failed to load export modules:', error);
                showToast(`Failed to load export modules: ${error.message}`, 'error');
            }
        },
        
        getModuleIcon(moduleKey) {
            const icons = {
                'students': 'users',
                'teachers': 'user-check',
                'subjects': 'book-open',
                'transport': 'bus',
                'fees': 'credit-card',
                'student_fees': 'receipt',
                'fines': 'alert-circle',
                'attendance': 'calendar-check',
                'promotion': 'trending-up',
                'messaging': 'message-circle',
                'users': 'user-cog',
                'fees_report': 'file-bar-chart'
            };
            return icons[moduleKey] || 'file';
        },
        
        async exportData(moduleKey, format) {
            if (this.exporting) return;
            
            this.exporting = true;
            showToast(`Exporting ${moduleKey} data as ${format.toUpperCase()}...`, 'info');
            
            try {
                const response = await fetch(`/backup/api/export/${moduleKey}/${format}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                
                if (response.ok) {
                    // Get filename from response headers or create default
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `${moduleKey}_export.${format}`;
                    
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    // Create download link
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showToast(`${moduleKey} data exported successfully!`, 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Export failed');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast(`Failed to export ${moduleKey} data: ${error.message}`, 'error');
            } finally {
                this.exporting = false;
            }
        }
    }
}

// Utility functions
function getCookie(name) {
    // console.log('ðŸª Getting cookie:', name);
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        console.log('ðŸª Available cookies:', cookies.map(c => c.trim().split('=')[0]));
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    console.log('ðŸª Cookie value found:', {
        name: name,
        found: !!cookieValue,
        length: cookieValue ? cookieValue.length : 0
    });
    return cookieValue;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-20 right-4 z-50 p-4 rounded-xl shadow-lg animate-slide-in ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    } text-white`;
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' : 
                type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'
            } mr-3"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 500);
    }, 5000);
}

function createQuickBackup(type) {
    const typeNames = {
        'full': 'Complete System',
        'students': 'Student Records',
        'financial': 'Financial Data', 
        'teachers': 'Staff Records'
    };
    
    showToast(`Creating ${typeNames[type]} backup...`, 'info');
    
    fetch('/backup/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            backup_name: `${type}_backup`,
            backup_type: type
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.id || data.status === 'success') {
            showToast(data.message || `${typeNames[type]} backup created successfully!`, 'success');
            loadBackupHistory();
        } else if (data.error) {
            showToast(data.error, 'error');
        } else {
            showToast('Backup creation completed', 'success');
            loadBackupHistory();
        }
    })
    .catch(error => {
        console.error('Backup error:', error);
        if (error.message.includes('429')) {
            showToast('You\'ve reached the backup limit. Please wait a moment before creating another backup.', 'error');
        } else {
            showToast('Oops! We couldn\'t create the backup right now. Please try again.', 'error');
        }
    });
}

function createBackup() {
    const backupBtn = document.getElementById('backupBtn');
    const backupName = document.getElementById('backupName').value.trim();
    const backupType = document.getElementById('backupType').value;
    
    if (!backupName) {
        showToast('Please give your backup a name so you can find it later.', 'error');
        return;
    }
    
    backupBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Creating your backup...';
    backupBtn.disabled = true;
    
    fetch('/backup/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            backup_name: backupName,
            backup_type: backupType
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.id || data.status === 'success') {
            showToast(data.message || 'Great! Your backup has been created successfully.', 'success');
            document.getElementById('backupName').value = '';
            loadBackupHistory();
        } else if (data.error) {
            showToast(data.error, 'error');
        } else {
            showToast('Backup creation completed', 'success');
            document.getElementById('backupName').value = '';
            loadBackupHistory();
        }
    })
    .catch(error => {
        console.error('Backup error:', error);
        if (error.message.includes('429')) {
            showToast('You\'ve reached the backup limit. Please wait a moment before creating another backup.', 'error');
        } else {
            showToast('Sorry, we couldn\'t create your backup. Please check your connection and try again.', 'error');
        }
    })
    .finally(() => {
        backupBtn.innerHTML = '<i class="fas fa-save mr-3"></i>Create Backup Now';
        backupBtn.disabled = false;
    });
}

let showingAll = false;

function loadBackupHistory() {
    console.log('ðŸ“š loadBackupHistory called with showingAll:', showingAll);
    
    const tbody = document.getElementById('backupHistoryTableBody');
    const statusText = document.getElementById('historyStatusText');
    const showAllBtn = document.getElementById('showAllBtn');
    
    tbody.innerHTML = `
        <tr>
            <td colspan="4" class="px-6 py-12 text-center">
                <div class="flex flex-col items-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Loading your backup archive...</p>
                </div>
            </td>
        </tr>
    `;
    
    const historyUrl = `/backup/history/?show_all=${showingAll}`;
    console.log('ðŸŒ Fetching backup history from:', historyUrl);
    
    fetch(historyUrl)
    .then(response => {
        console.log('ðŸ“¡ History response:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            url: response.url
        });
        return response.json();
    })
    .then(data => {
        console.log('ðŸ“¦ History data received:', data);
        
        if (data.status === 'success') {
            console.log('âœ… History loaded successfully, records count:', data.data.length);
            
            if (data.data.length === 0) {
                console.log('ðŸ“­ No backup records found');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-folder-open text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">No backup files found. Create your first backup above!</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log('ðŸ“‹ Rendering backup records:', data.data.map(b => ({ id: b.id, file_name: b.file_name, operation_type: b.operation_type })));
            
            tbody.innerHTML = data.data.map(backup => {
                const date = new Date(backup.date).toLocaleString();
                const typeClass = backup.operation_type === 'backup' ? 'badge-success' : 'badge-info';
                console.log('ðŸ”„ Rendering backup row:', { id: backup.id, file_name: backup.file_name, date: backup.date });
                return `
                    <tr class="hover:bg-gradient-to-r hover:from-purple-50 hover:to-indigo-50 transition-all duration-300">
                        <td class="px-6 py-4 font-medium text-gray-900">${backup.file_name}</td>
                        <td class="px-6 py-4 text-gray-700">${date}</td>
                        <td class="px-6 py-4"><span class="badge ${typeClass}">${backup.operation_type}</span></td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="restoreFromHistory(${backup.id})" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md" title="Smart Restore">
                                    <i class="fas fa-magic"></i>
                                </button>
                                <button onclick="deleteBackup(${backup.id})" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-3 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md" title="Delete this backup">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            statusText.textContent = showingAll ? `Showing all ${data.data.length} backup files` : 'Showing your 5 most recent backups';
            showAllBtn.innerHTML = showingAll ? '<i class="fas fa-compress mr-2"></i>Show Less' : '<i class="fas fa-list mr-2"></i>Show All';
            console.log('âœ… History table rendered successfully');
        } else {
            console.error('âŒ History loading failed:', data);
        }
    })
    .catch(error => {
        console.error('ðŸ’¥ History loading error:', {
            error: error,
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
        });
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-6 py-12 text-center">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i>
                        <p class="text-red-500">We're having trouble loading your backup history. Please refresh the page.</p>
                        <button onclick="loadBackupHistory()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Try Again
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
}

function restoreFromHistory(backupId) {
    console.log('ðŸ”„ restoreFromHistory called with backupId:', backupId);
    console.log('ðŸ“Š Current page state:', {
        showingAll: showingAll,
        currentAnalysis: currentAnalysis,
        timestamp: new Date().toISOString()
    });
    
    // Show smart restore options modal
    showSmartRestoreModal(backupId);
}

function showSmartRestoreModal(backupId) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-magic text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Smart Restore Options</h3>
                <p class="text-gray-600 mt-2">Choose how to restore this backup</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Restore Category</label>
                    <select id="modalRestoreCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="full">Complete System Restore</option>
                        <option value="students">Student Records Only</option>
                        <option value="staff">Staff Records Only</option>
                        <option value="financial">Financial Data Only</option>
                        <option value="transport">Transport Data Only</option>
                        <option value="core">Core Settings Only</option>
                        <option value="system">System Data (Users, Messages, Reports)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Restore Mode</label>
                    <select id="modalRestoreMode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="merge">Merge (Safe - Keep existing data)</option>
                        <option value="replace">Replace (Warning - Clear existing data)</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button onclick="executeSmartHistoryRestore(${backupId})" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all">
                    Start Restore
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal function
    window.closeModal = function() {
        document.body.removeChild(modal);
        delete window.closeModal;
        delete window.executeSmartHistoryRestore;
    };
    
    // Execute restore function
    window.executeSmartHistoryRestore = function(backupId) {
        console.log('=== FRONTEND RESTORE START ===');
        console.log('ðŸš€ executeSmartHistoryRestore called');
        console.log('ðŸ“‹ Backup ID:', backupId);
        console.log('ðŸ• Timestamp:', new Date().toISOString());
        console.log('ðŸŒ Current URL:', window.location.href);
        console.log('ðŸ‘¤ User Agent:', navigator.userAgent);
        
        const category = document.getElementById('modalRestoreCategory').value;
        const mode = document.getElementById('modalRestoreMode').value;
        
        console.log('âš™ï¸ Restore parameters:', {
            backupId: backupId,
            category: category,
            mode: mode,
            timestamp: new Date().toISOString()
        });
        
        closeModal();
        
        const modeWarning = mode === 'replace' ? 
            'WARNING: Replace mode will delete existing data. Are you absolutely sure?' :
            'This will merge the backup data with your existing data. Continue?';
        
        if (!confirm(modeWarning)) {
            console.log('âŒ User cancelled restore operation');
            return;
        }
        
        console.log('âœ… User confirmed restore operation');
        showToast('Starting smart restore process...', 'info');
        
        const requestUrl = `/backup/restore/history/${backupId}/`;
        const csrfToken = getCookie('csrftoken');
        const requestBody = {
            restore_category: category,
            restore_mode: mode
        };
        
        console.log('=== REQUEST DETAILS ===');
        console.log('ðŸŒ Making POST request:', {
            url: requestUrl,
            method: 'POST',
            hasCSRFToken: !!csrfToken,
            csrfTokenLength: csrfToken ? csrfToken.length : 0,
            requestBody: requestBody,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken ? '[PRESENT]' : '[MISSING]'
            }
        });
        console.log('ðŸ“¤ Request URL:', requestUrl);
        console.log('ðŸ“¤ Request Method:', 'POST');
        console.log('ðŸ“¤ CSRF Token:', csrfToken ? `${csrfToken.substring(0, 8)}...` : 'MISSING');
        console.log('ðŸ“¤ Request Body JSON:', JSON.stringify(requestBody, null, 2));
        console.log('ðŸ“¤ Content-Type:', 'application/json');
        
        fetch(requestUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            console.log('=== RESPONSE RECEIVED ===');
            console.log('ðŸ“¡ Response received:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                headers: Object.fromEntries(response.headers.entries()),
                url: response.url
            });
            console.log('ðŸ“¥ Response Status:', response.status);
            console.log('ðŸ“¥ Response Status Text:', response.statusText);
            console.log('ðŸ“¥ Response OK:', response.ok);
            console.log('ðŸ“¥ Response Headers:', Object.fromEntries(response.headers.entries()));
            console.log('ðŸ“¥ Response URL:', response.url);
            console.log('ðŸ“¥ Response Type:', response.type);
            console.log('ðŸ“¥ Response Redirected:', response.redirected);
            
            if (!response.ok) {
                console.error('=== HTTP ERROR DETECTED ===');
                console.error('âŒ HTTP Error:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url
                });
                console.error('âŒ Error Status:', response.status);
                console.error('âŒ Error Status Text:', response.statusText);
                console.error('âŒ Error URL:', response.url);
                
                // Try to get response text for more details
                response.text().then(errorText => {
                    console.error('âŒ Error Response Body:', errorText);
                }).catch(textError => {
                    console.error('âŒ Could not read error response body:', textError);
                });
                
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('ðŸ“¦ Response data:', data);
            
            if (data.status === 'success') {
                console.log('âœ… Restore successful:', data);
                showToast(data.message, 'success');
                
                // Show detailed results
                if (data.summary) {
                    const summary = data.summary;
                    console.log('ðŸ“Š Restore summary:', summary);
                    showToast(`Restore completed: ${summary.created} created, ${summary.updated} updated, ${summary.skipped} skipped`, 'info');
                }
                
                loadBackupHistory();
            } else {
                console.error('âŒ Restore failed:', data);
                showToast(data.message || 'Smart restore failed', 'error');
            }
        })
        .catch(error => {
            console.error('=== FRONTEND ERROR CAUGHT ===');
            console.error('ðŸ’¥ Smart history restore error:', {
                error: error,
                message: error.message,
                stack: error.stack,
                name: error.name,
                timestamp: new Date().toISOString()
            });
            console.error('ðŸ’¥ Error Type:', error.constructor.name);
            console.error('ðŸ’¥ Error Message:', error.message);
            console.error('ðŸ’¥ Error Stack:', error.stack);
            console.error('ðŸ’¥ Error Name:', error.name);
            console.error('ðŸ’¥ Error Timestamp:', new Date().toISOString());
            
            // Additional context
            console.error('ðŸ’¥ Request Context:', {
                backupId: backupId,
                category: category,
                mode: mode,
                url: requestUrl,
                userAgent: navigator.userAgent,
                currentUrl: window.location.href
            });
            
            showToast('We encountered an issue during restore. Please try again.', 'error');
        })
        .finally(() => {
            console.log('=== FRONTEND RESTORE END ===');
            console.log('ðŸ Request completed at:', new Date().toISOString());
        });
    };
}

function deleteBackup(backupId) {
    if (!confirm('Are you sure you want to delete this backup file? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/backup/delete/${backupId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Backup file deleted successfully.', 'success');
            loadBackupHistory();
        } else {
            showToast(data.message || 'We couldn\'t delete the backup file. Please try again.', 'error');
        }
    })
    .catch(error => {
        showToast('Something went wrong while deleting. Please try again.', 'error');
    });
}

// Smart Restore Functions
let currentAnalysis = null;

function analyzeBackupFile() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const fileInput = document.getElementById('smartRestoreFile');
    const analysisResults = document.getElementById('analysisResults');
    const smartRestoreBtn = document.getElementById('smartRestoreBtn');
    
    if (!fileInput.files[0]) {
        showToast('Please select a backup file to analyze.', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('backup_file', fileInput.files[0]);
    
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Analyzing...';
    analyzeBtn.disabled = true;
    
    fetch('/backup/restore/analyze/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Analysis response data:', data);
        if (data.status === 'success' && data.data && data.data.analysis) {
            currentAnalysis = data.data.analysis;
            displayAnalysisResults(data.data.analysis, data.data.file_name, data.data.file_size);
            analysisResults.classList.remove('hidden');
            smartRestoreBtn.disabled = false;
            showToast('Backup analysis completed successfully!', 'success');
        } else {
            console.error('Analysis failed or missing data:', data);
            showToast(data.message || 'Analysis failed - invalid response data', 'error');
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        showToast('Failed to analyze backup file. Please try again.', 'error');
    })
    .finally(() => {
        analyzeBtn.innerHTML = '<i class="fas fa-search mr-3"></i>Analyze Backup';
        analyzeBtn.disabled = false;
    });
}

function displayAnalysisResults(analysis, fileName, fileSize) {
    const analysisContent = document.getElementById('analysisContent');
    
    if (!analysis || !analysis.categories_found) {
        console.error('Analysis error: Invalid analysis object:', analysis);
        analysisContent.innerHTML = '<div class="text-red-600">Error: Invalid analysis data received</div>';
        return;
    }
    
    const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);
    
    let categoriesHtml = '';
    for (const [category, data] of Object.entries(analysis.categories_found)) {
        categoriesHtml += `
            <div class="flex justify-between items-center bg-white rounded-lg p-3 border border-blue-200">
                <div>
                    <span class="font-semibold text-blue-800 capitalize">${category}</span>
                    <span class="text-sm text-gray-600 ml-2">${data.count} records</span>
                </div>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                    ${data.models.length} models
                </span>
            </div>
        `;
    }
    
    let recommendationsHtml = '';
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        recommendationsHtml = `
            <div class="mt-4">
                <h5 class="font-semibold text-blue-800 mb-2">Recommendations:</h5>
                <ul class="space-y-1">
                    ${analysis.recommendations.map(rec => `<li class="text-sm text-blue-700">â€¢ ${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    analysisContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-white rounded-lg p-3 border border-blue-200 text-center">
                <div class="text-2xl font-bold text-blue-800">${analysis.total_records || 0}</div>
                <div class="text-sm text-gray-600">Total Records</div>
            </div>
            <div class="bg-white rounded-lg p-3 border border-blue-200 text-center">
                <div class="text-2xl font-bold text-green-600">${analysis.categories_found ? Object.keys(analysis.categories_found).length : 0}</div>
                <div class="text-sm text-gray-600">Data Categories</div>
            </div>
            <div class="bg-white rounded-lg p-3 border border-blue-200 text-center">
                <div class="text-2xl font-bold text-purple-600">${fileSizeMB}MB</div>
                <div class="text-sm text-gray-600">File Size</div>
            </div>
        </div>
        
        <div class="mb-4">
            <h5 class="font-semibold text-blue-800 mb-3">Data Categories Found:</h5>
            <div class="space-y-2">
                ${categoriesHtml}
            </div>
        </div>
        
        ${recommendationsHtml}
        
        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-800">
                <i class="fas fa-check-circle mr-2"></i>
                Backup file is valid and ready for restoration. Choose your restore options above and click "Start Smart Restore".
            </p>
        </div>
    `;
}

function performSmartRestore() {
    const smartRestoreBtn = document.getElementById('smartRestoreBtn');
    const fileInput = document.getElementById('smartRestoreFile');
    const restoreCategory = document.getElementById('restoreCategory').value;
    const restoreMode = document.getElementById('restoreMode').value;
    
    if (!fileInput.files[0]) {
        showToast('Please select a backup file first.', 'error');
        return;
    }
    
    if (!currentAnalysis) {
        showToast('Please analyze the backup file first.', 'error');
        return;
    }
    
    const modeWarning = restoreMode === 'replace' ? 
        'WARNING: Replace mode will delete existing data. Are you absolutely sure?' :
        'This will merge the backup data with your existing data. Continue?';
    
    if (!confirm(modeWarning)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('backup_file', fileInput.files[0]);
    formData.append('restore_category', restoreCategory);
    formData.append('restore_mode', restoreMode);
    
    smartRestoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Restoring...';
    smartRestoreBtn.disabled = true;
    
    fetch('/backup/restore/upload/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            
            // Show detailed results
            if (data.summary) {
                const summary = data.summary;
                showToast(`Restore completed: ${summary.created} created, ${summary.updated} updated, ${summary.skipped} skipped`, 'info');
            }
            
            // Reset form
            fileInput.value = '';
            document.getElementById('analysisResults').classList.add('hidden');
            currentAnalysis = null;
            smartRestoreBtn.disabled = true;
            
            loadBackupHistory();
        } else {
            showToast(data.message || 'Restore failed', 'error');
        }
    })
    .catch(error => {
        console.error('Smart restore error:', error);
        showToast('Smart restore failed. Please try again.', 'error');
    })
    .finally(() => {
        smartRestoreBtn.innerHTML = '<i class="fas fa-magic mr-3"></i>Start Smart Restore';
        smartRestoreBtn.disabled = false;
    });
}

// Event listeners
document.getElementById('backupBtn').addEventListener('click', createBackup);
document.getElementById('analyzeBtn').addEventListener('click', analyzeBackupFile);
document.getElementById('smartRestoreBtn').addEventListener('click', performSmartRestore);
document.getElementById('refreshBtn').addEventListener('click', loadBackupHistory);
document.getElementById('showAllBtn').addEventListener('click', function() {
    showingAll = !showingAll;
    loadBackupHistory();
});

// File input change listener for auto-reset
document.getElementById('smartRestoreFile').addEventListener('change', function() {
    document.getElementById('analysisResults').classList.add('hidden');
    document.getElementById('smartRestoreBtn').disabled = true;
    currentAnalysis = null;
});

// Load backup history on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Page loaded, initializing backup restore interface');
    console.log('ðŸŒ Current URL:', window.location.href);
    console.log('ðŸ“± User Agent:', navigator.userAgent);
    console.log('ðŸ• Timestamp:', new Date().toISOString());
    
    // Check for required elements
    const requiredElements = [
        'backupHistoryTableBody',
        'historyStatusText', 
        'showAllBtn',
        'backupBtn',
        'analyzeBtn',
        'smartRestoreBtn'
    ];
    
    console.log('ðŸ” Checking required DOM elements:');
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`  ${id}:`, element ? 'âœ… Found' : 'âŒ Missing');
    });
    
    loadBackupHistory();
    
    // Animate cards on load
    const cards = document.querySelectorAll('.grid > div, .bg-white');
    console.log('ðŸŽ¨ Animating', cards.length, 'cards');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    console.log('âœ… Page initialization complete');
});
</script>

<!-- Enhanced Backup JavaScript Integration -->
<script>
// Integration with enhanced backup system
document.addEventListener('DOMContentLoaded', function() {
    // Load the enhanced backup JavaScript
    const script = document.createElement('script');
    script.src = '/static/backup/enhanced_backup_js.js';
    script.onload = function() {
        console.log('âœ… Enhanced backup JavaScript loaded');
    };
    script.onerror = function() {
        console.warn('âš ï¸ Enhanced backup JavaScript failed to load, using fallback');
    };
    document.head.appendChild(script);
});
</script>

{% block extra_css %}
<style>
@keyframes slide-in {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.animate-slide-in {
    animation: slide-in 0.3s ease-out;
}

/* Enhanced form styling */
.form-input, .form-select, .form-textarea {
    @apply w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:ring-0 transition-all duration-300 bg-white;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    @apply shadow-lg transform scale-[1.02];
}

/* File input styling */
input[type="file"] {
    @apply border-2 border-dashed border-gray-300 rounded-xl p-4 hover:border-blue-400 transition-colors cursor-pointer;
}

/* Button hover effects */
.btn {
    @apply transition-all duration-300 transform hover:scale-105;
}

/* Badge styling */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.badge-success {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
}

.badge-info {
    background: linear-gradient(135deg, #3B82F6, #1D4ED8);
    color: white;
}
</style>
{% endblock %}
{% endblock %}